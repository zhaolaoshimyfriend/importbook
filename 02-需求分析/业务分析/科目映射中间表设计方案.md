# 科目映射中间表设计方案

## 设计目标

1. **记录源系统科目信息**：完整记录导入前的源系统科目数据
2. **记录映射结果**：记录程序自动匹配或用户手动确认的映射关系
3. **支持用户修改**：允许用户查看、修改、确认映射关系
4. **支持后续处理**：确认后的映射关系用于后续导账处理流程

## 中间表结构设计

### 表名：`account_mapping_temp` 或 `subject_mapping_intermediate`

### 字段设计

#### 一、基础标识字段

| 字段名 | 类型 | 长度 | 是否必填 | 说明 |
|--------|------|------|----------|------|
| `id` | BIGINT | - | 是 | 主键，自增ID |
| `mapping_batch_id` | VARCHAR | 50 | 是 | 映射批次ID，一次导账操作一个批次 |
| `source_system_code` | VARCHAR | 50 | 是 | 源系统编码（如：用友、金蝶、SAP等） |
| `source_system_name` | VARCHAR | 100 | 是 | 源系统名称 |

**设计意义**：
- `id`：唯一标识每条映射记录
- `mapping_batch_id`：支持批量导账，同一批次的映射可以统一管理
- `source_system_code/name`：标识数据来源，便于后续追溯和复用映射关系

#### 二、源系统科目信息字段（映射前）

| 字段名 | 类型 | 长度 | 是否必填 | 说明 |
|--------|------|------|----------|------|
| `source_subject_code` | VARCHAR | 50 | 是 | 源系统科目编码 |
| `source_subject_name` | VARCHAR | 200 | 是 | 源系统科目名称 |
| `source_subject_code_original` | VARCHAR | 50 | 否 | 源系统原始科目编码（清洗前） |
| `source_subject_name_original` | VARCHAR | 200 | 否 | 源系统原始科目名称（清洗前） |
| `source_parent_code` | VARCHAR | 50 | 否 | 源系统父科目编码 |
| `source_parent_name` | VARCHAR | 200 | 否 | 源系统父科目名称 |
| `source_subject_level` | INT | - | 否 | 源系统科目层级（1级、2级等） |
| `source_subject_type` | VARCHAR | 20 | 否 | 源系统科目类型（资产/负债/权益/收入/费用） |
| `source_debit_credit` | VARCHAR | 10 | 否 | 源系统余额方向（借/贷） |
| `source_auxiliary_info` | TEXT | - | 否 | 源系统辅助核算信息（JSON格式） |
| `source_is_enabled` | TINYINT | - | 否 | 源系统科目是否启用（1启用/0停用） |
| `source_remark` | VARCHAR | 500 | 否 | 源系统科目备注 |

**设计意义**：
- **完整记录源系统数据**：保留原始数据，便于追溯和问题排查
- **支持数据清洗**：`*_original`字段保留清洗前的原始数据
- **层级关系**：记录父科目信息，支持层级匹配
- **科目属性**：记录类型、方向等，用于匹配验证
- **辅助核算**：JSON格式存储，支持复杂的辅助核算结构

#### 三、目标系统科目信息字段（映射后）

| 字段名 | 类型 | 长度 | 是否必填 | 说明 |
|--------|------|------|----------|------|
| `target_subject_code` | VARCHAR | 50 | 否 | 目标系统科目编码（小企业会计准则） |
| `target_subject_name` | VARCHAR | 200 | 否 | 目标系统科目名称 |
| `target_parent_code` | VARCHAR | 50 | 否 | 目标系统父科目编码 |
| `target_subject_level` | INT | - | 否 | 目标系统科目层级 |
| `target_subject_type` | VARCHAR | 20 | 否 | 目标系统科目类型 |
| `target_debit_credit` | VARCHAR | 10 | 否 | 目标系统余额方向 |
| `target_auxiliary_info` | TEXT | - | 否 | 目标系统辅助核算信息（JSON格式） |

**设计意义**：
- **映射结果记录**：记录程序匹配或用户确认的目标科目
- **支持验证**：通过对比源系统和目标系统的属性，验证映射合理性
- **支持一对多映射**：一个源科目可以映射到多个目标科目（需要关联表）

#### 四、匹配过程字段

| 字段名 | 类型 | 长度 | 是否必填 | 说明 |
|--------|------|------|----------|------|
| `match_type` | VARCHAR | 50 | 是 | 匹配类型（见下方说明） |
| `match_method` | VARCHAR | 50 | 是 | 匹配方法（见下方说明） |
| `match_score` | DECIMAL | 5,2 | 否 | 匹配度评分（0-100） |
| `match_confidence` | VARCHAR | 20 | 否 | 匹配置信度（高/中/低） |
| `match_reason` | TEXT | - | 否 | 匹配依据说明（为什么这样匹配） |
| `candidate_subjects` | TEXT | - | 否 | 候选科目列表（JSON格式，多个候选） |
| `llm_response` | TEXT | - | 否 | 大模型返回的原始响应（用于大模型匹配） |

**匹配类型（match_type）枚举值**：
- `exact_match`：完全匹配（编码+名称完全一致）
- `code_match`：编码匹配（编码相同，名称可能不同）
- `name_match`：名称匹配（名称相同，编码不同）
- `semantic_match`：语义匹配（使用大模型或相似度算法）
- `hierarchy_match`：层级匹配（通过父科目匹配）
- `manual_mapping`：手动映射（用户手动选择）
- `unmatched`：未匹配（无法找到对应科目）
- `multi_target`：多对一映射（一个源科目映射多个目标）

**匹配方法（match_method）枚举值**：
- `direct`：直接匹配（字符串完全一致）
- `traditional_rule`：传统规则匹配（编码规则、层级规则）
- `llm_semantic`：大模型语义匹配
- `similarity_algorithm`：相似度算法（编辑距离等）
- `manual`：手动映射
- `template`：模板匹配（使用历史映射模板）

**设计意义**：
- **匹配过程可追溯**：记录匹配类型和方法，便于问题排查
- **匹配质量评估**：通过评分和置信度，判断匹配质量
- **支持人工审核**：低置信度匹配需要人工确认
- **候选列表**：记录多个候选，用户可以选择
- **大模型响应**：保留原始响应，便于优化Prompt

#### 五、处理状态字段

| 字段名 | 类型 | 长度 | 是否必填 | 说明 |
|--------|------|------|----------|------|
| `mapping_status` | VARCHAR | 20 | 是 | 映射状态（见下方说明） |
| `review_status` | VARCHAR | 20 | 否 | 审核状态（见下方说明） |
| `is_confirmed` | TINYINT | - | 是 | 是否已确认（1已确认/0未确认） |
| `is_modified` | TINYINT | - | 是 | 是否被用户修改过（1已修改/0未修改） |
| `validation_result` | VARCHAR | 20 | 否 | 验证结果（pass/fail/warning） |
| `validation_message` | TEXT | - | 否 | 验证失败原因或警告信息 |
| `conflict_flag` | TINYINT | - | 是 | 是否存在映射冲突（1有冲突/0无冲突） |
| `conflict_detail` | TEXT | - | 否 | 冲突详情说明 |

**映射状态（mapping_status）枚举值**：
- `pending`：待处理（刚导入，未匹配）
- `processing`：处理中（正在匹配）
- `matched`：已匹配（程序已匹配，待确认）
- `confirmed`：已确认（用户已确认）
- `rejected`：已拒绝（用户拒绝此映射）
- `skipped`：已跳过（用户选择跳过此科目）

**审核状态（review_status）枚举值**：
- `not_reviewed`：未审核
- `auto_approved`：自动通过（高置信度自动确认）
- `manual_approved`：人工通过（用户确认）
- `need_review`：待审核（需要人工审核）
- `rejected`：已拒绝

**设计意义**：
- **流程控制**：通过状态字段控制映射流程
- **用户操作记录**：记录用户是否修改、确认
- **质量保证**：验证结果确保映射合理性
- **冲突处理**：检测并记录映射冲突

#### 六、审计追踪字段

| 字段名 | 类型 | 长度 | 是否必填 | 说明 |
|--------|------|------|----------|------|
| `created_at` | DATETIME | - | 是 | 创建时间 |
| `created_by` | VARCHAR | 50 | 否 | 创建人（系统/用户ID） |
| `matched_at` | DATETIME | - | 否 | 匹配时间 |
| `matched_by` | VARCHAR | 50 | 否 | 匹配执行者（系统/算法名称） |
| `modified_at` | DATETIME | - | 否 | 最后修改时间 |
| `modified_by` | VARCHAR | 50 | 否 | 最后修改人 |
| `confirmed_at` | DATETIME | - | 否 | 确认时间 |
| `confirmed_by` | VARCHAR | 50 | 否 | 确认人 |
| `reviewed_at` | DATETIME | - | 否 | 审核时间 |
| `reviewed_by` | VARCHAR | 50 | 否 | 审核人 |
| `version` | INT | - | 是 | 版本号（支持版本管理） |

**设计意义**：
- **完整审计链**：记录所有操作的时间和操作人
- **问题追溯**：出现问题时可以追溯是谁、什么时候、做了什么操作
- **版本管理**：支持映射关系的版本管理，可以回退

#### 七、业务扩展字段

| 字段名 | 类型 | 长度 | 是否必填 | 说明 |
|--------|------|------|----------|------|
| `remark` | TEXT | - | 否 | 备注说明（用户备注、特殊说明等） |
| `tag` | VARCHAR | 100 | 否 | 标签（用于分类、筛选） |
| `priority` | INT | - | 否 | 优先级（用于排序） |
| `export_flag` | TINYINT | - | 是 | 是否导出到后续流程（1导出/0不导出） |
| `template_id` | VARCHAR | 50 | 否 | 使用的映射模板ID（如果使用模板） |

**设计意义**：
- **用户备注**：允许用户添加备注说明
- **标签分类**：支持灵活的标签分类
- **优先级控制**：重要科目优先处理
- **流程控制**：控制是否进入后续导账流程
- **模板复用**：记录使用的模板，支持模板管理

## 一对多映射处理

如果一个源科目需要映射到多个目标科目，有两种设计方案：

### 方案一：主表+明细表（推荐）

**主表**：`account_mapping_temp`（记录源科目信息）
**明细表**：`account_mapping_detail`（记录一对多映射关系）

明细表字段：
- `mapping_id`：关联主表ID
- `target_subject_code`：目标科目编码
- `target_subject_name`：目标科目名称
- `split_rule`：拆分规则（按比例/按金额范围等）
- `split_ratio`：拆分比例（如果是按比例拆分）

### 方案二：JSON字段存储

在主表的`target_subject_code`字段中存储JSON数组：
```json
[
  {"code": "1001", "name": "库存现金", "ratio": 0.6},
  {"code": "1002", "name": "银行存款", "ratio": 0.4}
]
```

## 索引设计

```sql
-- 主键索引
PRIMARY KEY (`id`)

-- 批次查询索引
INDEX `idx_batch_id` (`mapping_batch_id`)

-- 源系统查询索引
INDEX `idx_source_system` (`source_system_code`, `source_subject_code`)

-- 目标系统查询索引
INDEX `idx_target_subject` (`target_subject_code`)

-- 状态查询索引
INDEX `idx_status` (`mapping_status`, `is_confirmed`)

-- 匹配类型查询索引
INDEX `idx_match_type` (`match_type`, `match_method`)

-- 复合索引（常用查询组合）
INDEX `idx_batch_status` (`mapping_batch_id`, `mapping_status`, `is_confirmed`)
```

## 使用流程

### 1. 数据导入阶段
- 将源系统科目数据导入中间表
- 填充"源系统科目信息字段"
- 状态设置为`pending`

### 2. 自动匹配阶段
- 程序执行匹配算法
- 填充"目标系统科目信息字段"和"匹配过程字段"
- 状态设置为`matched`

### 3. 用户审核阶段
- 用户查看映射结果
- 可以修改目标科目
- 可以查看匹配依据和候选列表
- 确认或拒绝映射

### 4. 确认后处理
- 用户确认后，`is_confirmed=1`
- `export_flag=1`的记录进入后续导账流程
- 可以导出为正式的映射关系表

## 与其他财务软件的对比

### 用友U8导账设计
- 使用临时表存储导入数据
- 支持映射关系配置
- 支持批量确认

### 金蝶KIS导账设计
- 使用中间表记录映射关系
- 支持模板保存和复用
- 支持映射关系验证

### 本设计优势
1. **更完整的审计链**：记录所有操作过程
2. **更灵活的匹配方式**：支持大模型、规则、手动等多种方式
3. **更好的用户体验**：候选列表、匹配依据、可视化展示
4. **更强的扩展性**：JSON字段支持复杂数据结构

## 总结

这个中间表设计能够：
- ✅ 完整记录源系统科目信息（映射前）
- ✅ 完整记录映射结果（映射后）
- ✅ 支持用户查看和修改
- ✅ 支持用户确认操作
- ✅ 支持后续导账流程
- ✅ 完整的审计追踪
- ✅ 支持一对多映射
- ✅ 支持版本管理
