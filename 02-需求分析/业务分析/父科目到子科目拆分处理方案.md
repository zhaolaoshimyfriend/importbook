# 父科目到子科目拆分处理方案

## 一、业务场景描述

### 场景特征
- **源系统**：1901 待处理财产损溢（一级科目，有发生额和期初余额）
- **本系统**：1901 待处理财产损溢（一级科目，但**不允许直接使用**）
  - 190101 待处理流动资产损溢（子科目，必须使用）
  - 190102 待处理非流动资产损溢（子科目，必须使用）

### 核心问题
1. 源系统的一级科目余额/发生额，无法直接导入到本系统的一级科目（因为本系统强制要求使用子科目）
2. 需要将源系统的**一个科目**拆分成**两个子科目**，但源系统没有提供拆分依据

---

## 二、处理方案设计

### 方案一：按业务规则自动拆分（推荐）

#### 2.1 拆分策略

**策略A：按发生额性质拆分（推荐）**
- 如果源系统能提供**明细发生额**（如：每笔凭证的摘要、对方科目、金额），可以：
  - 根据**对方科目**判断：
    - 对方科目是流动资产类（如：1001库存现金、1122应收账款、1405库存商品等）→ 拆分到 190101
    - 对方科目是非流动资产类（如：1601固定资产、1701无形资产等）→ 拆分到 190102
  - 根据**凭证摘要**判断：
    - 摘要包含"流动资产"、"存货"、"现金"等关键词 → 190101
    - 摘要包含"固定资产"、"无形资产"、"长期资产"等关键词 → 190102

**策略B：按余额比例拆分（备选）**
- 如果无法获取明细发生额，只能按**余额比例**拆分：
  - 默认比例：50% → 190101，50% → 190102
  - 或根据历史经验比例（如：流动资产占70%，非流动资产占30%）
- **风险**：可能导致后续对账困难，需要人工调整

**策略C：全部拆分到默认子科目（不推荐）**
- 全部余额/发生额 → 190101（待处理流动资产损溢）
- **风险**：如果实际是非流动资产损溢，会导致分类错误

#### 2.2 实施步骤

1. **映射关系配置**：
   ```
   源系统：1901 待处理财产损溢
   ↓
   目标系统：1901 待处理财产损溢（父科目，仅作为映射目标，不实际使用）
   ↓
   拆分规则：按对方科目/摘要自动拆分
   ↓
   实际导入：
   - 190101 待处理流动资产损溢（拆分后的金额）
   - 190102 待处理非流动资产损溢（拆分后的金额）
   ```

2. **数据预处理**：
   - 读取源系统的**明细发生额**（凭证级别数据）
   - 根据拆分规则，将每笔发生额分配到对应的子科目
   - 汇总得到两个子科目的期初余额和发生额

3. **导入执行**：
   - 将拆分后的数据导入到 190101 和 190102
   - 1901 父科目保持为空（或仅作为汇总展示）

---

### 方案二：人工干预拆分（备选）

#### 2.1 适用场景
- 源系统无法提供明细发生额
- 自动拆分规则无法准确判断
- 金额较大，需要人工确认

#### 2.2 实施步骤

1. **映射关系配置**：
   - 在映射表中标记：1901 → 需要人工拆分

2. **生成拆分清单**：
   - 系统生成一个Excel文件，包含：
     - 源系统：1901 待处理财产损溢
     - 期初余额：XXX元
     - 本期发生额：XXX元
     - 需要拆分为：
       - 190101 待处理流动资产损溢：？元
       - 190102 待处理非流动资产损溢：？元

3. **人工填写拆分比例**：
   - 用户根据业务实际情况，填写拆分比例或金额
   - 系统根据用户填写的数据进行导入

---

### 方案三：混合方案（推荐用于复杂场景）

#### 3.1 实施逻辑
1. **优先自动拆分**：
   - 有明细发生额的，按策略A自动拆分
   - 无明细发生额的，按策略B（比例）自动拆分

2. **人工复核**：
   - 生成拆分报告，列出：
     - 自动拆分的依据
     - 拆分后的金额
     - 需要人工确认的异常情况

3. **人工调整**：
   - 用户可以在Excel中调整拆分比例
   - 系统根据调整后的数据重新导入

---

## 三、技术实现要点

### 3.1 映射关系表设计

在映射关系表中，需要支持**一对多拆分映射**：

| 字段 | 说明 |
|------|------|
| `source_subject_code` | 1901 |
| `target_subject_code` | 1901（父科目，仅作为映射目标） |
| `split_rule` | 按对方科目/摘要拆分 |
| `split_targets` | JSON格式：`[{"code":"190101","ratio":0.5},{"code":"190102","ratio":0.5}]` |
| `split_method` | auto/manual/mixed |

### 3.2 拆分规则配置

可以设计一个**拆分规则配置表**：

| 源科目 | 目标父科目 | 拆分规则 | 拆分依据 | 默认比例 |
|--------|-----------|---------|---------|---------|
| 1901 | 1901 | 按对方科目 | 流动资产→190101，非流动资产→190102 | 50%:50% |

### 3.3 数据导入流程

```
1. 读取源系统数据
   ↓
2. 识别需要拆分的科目（如：1901）
   ↓
3. 读取明细发生额（如果有）
   ↓
4. 应用拆分规则
   ↓
5. 生成拆分结果
   ↓
6. 人工复核（可选）
   ↓
7. 导入到目标系统子科目
```

---

## 四、其他类似场景

### 4.1 类似科目识别

检查本系统中还有哪些科目存在类似情况（父科目不允许直接使用，必须使用子科目）：

- **1901 待处理财产损溢**
  - 190101 待处理流动资产损溢
  - 190102 待处理非流动资产损溢

- **2211 应付职工薪酬**（可能）
  - 221101 职工工资
  - 221102 奖金、津贴和补贴
  - 221103 职工福利费
  - ...（多个子科目）

- **2221 应交税费**（可能）
  - 222101 应交增值税
  - 222102 未交增值税
  - 222103 应交消费税
  - ...（多个子科目）

### 4.2 处理原则

对于所有类似场景，统一处理原则：
1. **识别**：在映射关系表中标记需要拆分的科目
2. **拆分**：根据业务规则或人工配置进行拆分
3. **验证**：拆分后的金额总和 = 源系统原金额
4. **导入**：导入到目标系统的子科目

---

## 五、校验规则补充

在《映射结果校验规则分析》中，需要补充：

**规则 R17：父科目到子科目拆分完整性校验**
- 检查：源系统父科目余额/发生额是否完整拆分到目标系统子科目
- 验证：拆分后的子科目金额之和 = 源系统父科目金额
- 示例：
  - 源：1901 期初余额 1000元
  - 目标：190101 期初余额 600元 + 190102 期初余额 400元 = 1000元 ✓
  - 如果 600 + 400 ≠ 1000，则报错

**规则 R18：拆分规则合理性校验**
- 检查：拆分规则是否符合业务逻辑
- 示例：
  - 如果按"对方科目"拆分，需要验证对方科目分类是否正确
  - 如果按"比例"拆分，需要验证比例是否合理（不能全部拆分到一个子科目，除非有明确业务依据）

---

## 六、用户交互设计

### 6.1 拆分配置界面

在映射关系配置界面，对于需要拆分的科目，提供：
- **拆分方式选择**：自动拆分 / 人工拆分 / 混合模式
- **拆分规则配置**：按对方科目 / 按摘要 / 按比例
- **拆分结果预览**：显示拆分后的金额分布

### 6.2 拆分结果确认

生成拆分结果Excel，包含：
- 源系统科目信息
- 拆分规则说明
- 拆分后的子科目金额
- 人工调整区域（如果选择人工拆分）

---

## 七、总结

### 7.1 推荐方案
- **优先使用**：方案一（自动拆分）+ 方案三（混合方案）
- **拆分依据**：优先使用明细发生额（对方科目/摘要），其次使用比例拆分

### 7.2 关键要点
1. **映射关系表**需要支持一对多拆分映射
2. **拆分规则**需要可配置，支持多种拆分策略
3. **拆分结果**需要可验证（金额平衡校验）
4. **用户交互**需要支持人工复核和调整

### 7.3 实施优先级
1. **高优先级**：1901 待处理财产损溢（当前场景）
2. **中优先级**：2211 应付职工薪酬、2221 应交税费（如果也存在类似问题）
3. **低优先级**：其他可能存在类似情况的科目
