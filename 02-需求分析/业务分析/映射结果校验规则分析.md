# 映射结果校验规则分析

## 一、设计背景

在导账场景下，我们会生成一张**科目映射关系表**，用于记录：
- 源系统科目（对方财务软件）
- 目标系统科目（本系统：小企业会计准则）
- 以及匹配类型、置信度、来源规则等

这张映射关系表后续会直接作为**导账处理的依据**，决定历史余额和发生额如何落到本系统科目上。

为了保证导入后的账务**符合会计基本逻辑**、不会出现明显的“会计常识错误”，需要在映射关系表上增加一层**规则校验**，提前发现并拦截问题。

---

## 二、校验目标

1. **会计要素一致性**：
   - 避免资产类科目被映射到负债类或费用类科目
   - 避免收入科目映射到成本/费用等不合理情况

2. **余额方向合理性**：
   - 避免长期“借方余额”的科目映射到典型“贷方余额”的科目，反之亦然

3. **报表归属一致性**：
   - 避免应出现在资产负债表的项目映射到只出现在利润表的科目上
   - 避免直接影响利润表的科目被映射到不影响利润表的科目

4. **辅助核算维度完整性**：
   - 保证应按客户/供应商/存货等维度核算的科目，在映射后仍能保持可追溯性

5. **映射关系的完整性与唯一性**：
   - 避免漏映射、重复映射、不必要的一对多或多对一

6. **层级/结构合理性**：
   - 保证父科目与子科目的映射关系一致、不自相矛盾

---

## 三、映射结果表的关键字段（假设）

结合《科目映射中间表设计方案》，假设映射结果表至少包含：

- 源系统字段：
  - `source_subject_code` / `source_subject_name`
  - `source_subject_type`（资产/负债/权益/成本/损益）
  - `source_debit_credit`（借/贷）
  - `source_auxiliary_info`（客户/供应商/存货等）

- 目标系统字段：
  - `target_subject_code` / `target_subject_name`
  - `target_subject_type`（资产/负债/权益/成本/损益）
  - `target_debit_credit`（借/贷）
  - `target_auxiliary_info`
  - （可从默认科目表关联得到）
    - `资产负债表`（是/否）
    - `利润表`（是/否）
    - `是否直接影响资产负债表`
    - `是否直接影响利润表`

- 映射过程字段：
  - `match_type`（exact_match / semantic_match / manual_mapping 等）
  - `match_score` / `match_confidence`

---

## 四、校验规则清单（含示例）

### 4.1 会计要素一致性校验

**规则 R1：会计类别一致性（强约束）**
- 检查：`source_subject_type` 与 `target_subject_type` 是否相同
- 目的：防止以下不合理映射：
  - 资产 → 负债/权益/损益
  - 负债 → 资产/损益
  - 收入 → 费用/资产 等
- 示例：
  - 源："应收账款"（资产类） → 目标："应付账款"（负债类）
    - 结论：**严重错误**，应拦截
  - 源："主营业务收入"（损益-收入） → 目标："管理费用"（损益-费用）
    - 结论：**严重错误**，应拦截

**规则 R2：成本/损益与资产/负债的跨类映射（重点关注）**
- 检查：
  - 源为成本/损益类，目标为资产/负债/权益类，或反之
- 说明：
  - 部分极特殊业务（如以前年度损益调整、会计政策变更）可能涉及此类重分类，但**导账场景下一般不允许**，可按“高风险告警”处理。
- 示例：
  - 源："管理费用" → 目标："其他应收款"
    - 结论：高风险告警，一般不允许

---

### 4.2 余额方向合理性校验

**规则 R3：借贷方向一致性（强约束，允许白名单例外）**
- 检查：`source_debit_credit` 与 `target_debit_credit` 是否一致
- 目的：避免将长期借方余额科目映射到长期贷方余额科目
- 特殊：
  - 少数资产类备抵科目（如累计折旧、坏账准备）本身是贷方余额，这类在默认科目中已体现为“贷”。
- 示例：
  - 源："应收账款"（借方余额） → 目标："应付账款"（贷方余额）
    - 结论：与 R1 一致，为严重错误
  - 源："累计折旧"（贷方余额，资产类备抵） → 目标："累计折旧"（贷方余额）
    - 结论：合法

**规则 R4：借贷方向相反但会计类别相同（高风险告警）**
- 检查：类别相同，但借贷方向相反
- 示例：
  - 源："其他应收款"（借） → 目标："其他应收款-贷方调整"（贷）
    - 若存在此类科目，需要业务上确认是否为专门设计的调整科目，否则应视为异常

---

### 4.3 报表归属一致性校验

结合默认科目表中的：`资产负债表`、`利润表`、`是否直接影响资产负债表`、`是否直接影响利润表` 字段。

**规则 R5：资产负债表归属一致性**
- 检查：
  - 若源科目在源系统中标记为资产负债表项目（或推断为资产/负债/权益类），则目标科目也应满足：`资产负债表 = 是`。
- 示例：
  - 源："长期债券投资"（资产负债表=是） → 目标："主营业务收入"（资产负债表=否）
    - 结论：严重错误

**规则 R6：利润表归属一致性**
- 检查：
  - 源为损益类（`利润表 = 是`），目标也应为 `利润表 = 是` 的科目
- 示例：
  - 源："主营业务收入"（利润表=是） → 目标："未分配利润"（利润表=否）
    - 结论：严重错误

**规则 R7：直接影响报表的科目映射**
- 使用：`是否直接影响资产负债表`、`是否直接影响利润表`
- 检查：
  - 直接影响利润表的源科目 → 不应映射到“不直接影响利润表”的目标科目
  - 直接影响资产负债表的源科目 → 不应映射到“仅间接影响”的目标科目
- 示例：
  - 源："主营业务收入"（是否直接影响利润表=是） → 目标："以前年度损益调整"（若标记为仅间接影响）
  - 源："库存现金"（直接影响资产负债表=是） → 目标："管理费用"（不影响资产负债表）

---

### 4.4 辅助核算维度校验

**规则 R8：关键辅助核算一致性（客户/供应商/存货）**
- 检查：
  - 使用 `辅助核算是否必要` 列（1122/1405/2202）
  - 若源科目为“辅助核算必要=是”，则目标科目必须：
    - 也具备相同类型的辅助核算能力，或
    - 落到一个明确支持同等维度追踪的科目
- 示例：
  - 源："应收账款（客户）" → 目标："其他应收款（无客户维度）"
    - 结论：高风险，应提示“客户维度丢失”
  - 源："库存商品（存货）" → 目标："原材料（存货）"
    - 若两者都支持存货维度，可视为合理

**规则 R9：从“有辅助核算”映射到“无辅助核算”**
- 检查：
  - 源存在辅助核算（即使“非必要”），目标完全无辅助核算
- 处理：
  - 作为“信息丢失告警”，提示用户确认

---

### 4.5 层级与结构合理性校验

**规则 R10：父子科目结构一致性**
- 检查：
  - 若源父科目和子科目都参与映射，需保证目标侧结构不矛盾：
    - 源父科目 → 目标父科目
    - 源子科目 → 目标子科目
  - 避免：源多个子科目分别映射到完全不同类别的目标科目，导致结构割裂
- 示例：
  - 源：
    - 1501 长期债券投资（父）
    - 150101 债券投资（子）
    - 150102 其他债权投资（子）
  - 目标：
    - 1501 → 1501
    - 150101 → 1601 固定资产
    - 150102 → 1122 应收账款
    - 结论：结构严重不合理，应告警

**规则 R11：父子层级混映射**
- 场景：
  - 源仅有子科目有余额，对方系统只有父科目
- 合理做法：
  - 源多个子科目可以合并映射到目标父科目，但需要：
    - 明确“合并”的业务含义
    - 确认不会影响报表结构
- 校验点：
  - 若同一源父科目下的子科目被映射到多个不同的目标父科目，需要提示“结构拆分”告警

---

### 4.6 一对多 / 多对一映射校验

**规则 R12：多对一映射合理性**
- 场景：多个源科目合并到一个目标科目
- 校验：
  - 所有源科目应：
    - 会计类别一致或可合并（如多个费用科目合并到同一管理费用）
    - 余额方向一致
- 示例：
  - 源："差旅费"、"交通费" → 目标："管理费用-差旅及交通费"
    - 结论：合理
  - 源："主营业务收入"、"营业外收入" → 目标："主营业务收入"
    - 结论：高风险，应提示“不同性质收入合并”

**规则 R13：一对多映射完整性**
- 场景：一个源科目拆分到多个目标科目（需有比例或规则支撑）
- 校验：
  - 若存在拆分比例（如按金额比例、按项目维度），需要：
    - 比例之和=100%
    - 或拆分条件互斥且覆盖完整
- 示例：
  - 源："其他应收款" → 目标：
    - 50% → "其他应收款-员工借款"
    - 50% → "其他应收款-关联方"
    - 结论：需要检查拆分规则是否在系统中有明确配置

---

### 4.7 完整性与唯一性校验

**规则 R14：未映射科目检查**
- 检查：
  - 源系统所有“有余额或有发生额”的科目是否都出现在映射表中
- 目的：
  - 防止遗漏科目导致导入后数据不完整

**规则 R15：重复映射检查**
- 检查：
  - 同一源科目是否被多条记录映射到不同目标科目
- 处理：
  - 若一对多是“刻意设计”（如有拆分规则），则需有明确标记
  - 否则视为配置错误

**规则 R16：目标科目超载检查**
- 检查：
  - 某个目标科目是否被过多、性质差异很大的源科目映射
- 示例：
  - 多个资产、负债、收入、费用科目都映射到 "以前年度损益调整" 或 "其他应收款"
    - 结论：高风险，需人工重点复核

---

## 五、规则严重性分级建议

- **致命错误（Error）**：必须阻止导账
  - R1 会计类别明显不一致
  - R3 借贷方向严重不合理且无白名单例外
  - R5/R6 报表归属明显不一致

- **高风险告警（Warning）**：允许保存，但需用户明确确认
  - R2 成本/损益与资产/负债的跨类映射
  - R4 借贷方向相反但会计类别相同
  - R7 直接影响报表的科目被映射到“非直接”的目标
  - R8/R9 辅助核算维度可能丢失
  - R10/R11 结构明显不一致
  - R12/R13 一对多、多对一中性质差异较大

- **提示信息（Info）**：仅提示用户注意
  - R14 未映射科目列表
  - R15/R16 需要人工关注的集中映射现象

---

## 六、应用建议

1. **嵌入映射配置界面**：
   - 用户保存或批量导入映射关系时，自动跑一遍上述校验，给出错误/告警/提示列表。

2. **结合默认科目增强校验**：
   - 通过关联 `小企业会计准则-默认科目.csv` 中的：
     - `类别`
     - `借贷`
     - `资产负债表` / `利润表`
     - `是否直接影响资产负债表` / `是否直接影响利润表`
     - `辅助核算是否必要`
   - 可以大幅提升规则的准确性。

3. **与大模型结果联动**：
   - 对于大模型给出的语义匹配结果，可在写入映射表前先跑上述校验：
     - 若违反 R1/R3/R5/R6，直接打回，让大模型重新给出候选或要求人工干预。

4. **输出校验报告**：
   - 为每次导账批次生成“映射校验报告”，记录：
     - 错误条数
     - 告警条数
     - 涉及的关键科目清单
   - 便于实施顾问或会计人员复核和留档。

