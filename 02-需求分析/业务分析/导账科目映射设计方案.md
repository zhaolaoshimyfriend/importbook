# 导账科目映射设计方案

## 设计背景

- **本系统默认科目**：小企业会计准则默认科目（248个有效科目）
- **导账场景**：其他财务系统的科目与本系统科目可能存在较大不一致
- **设计目标**：建立高效、准确的科目映射机制，支持自动化匹配和人工干预

## 设计原则

1. **分层匹配策略**：先简单后复杂，先精确后模糊
2. **自动化优先**：尽可能自动匹配，减少人工干预
3. **可追溯性**：记录匹配依据和决策过程
4. **可扩展性**：支持不同来源系统的科目体系
5. **容错性**：处理异常情况和边界条件

## 核心设计架构

### 1. 三层匹配策略

```
第一层：传统精确匹配（71.4%的科目）
  ├─ 完全匹配（编码+名称）
  └─ 层级匹配（多级科目结构）

第二层：智能语义匹配（处理不一致情况）
  ├─ 编码相似度匹配
  ├─ 名称语义匹配
  └─ 同义词匹配

第三层：人工干预处理
  ├─ 候选列表选择
  ├─ 手动映射
  └─ 新增科目处理
```

### 2. 匹配流程设计

```
对方系统科目
    ↓
数据清洗和标准化
    ↓
第一层：传统匹配
    ├─ 完全匹配？ → 是 → 自动映射
    └─ 否 → 继续
    ↓
第二层：智能匹配
    ├─ 编码匹配？ → 是 → 提供候选
    ├─ 名称匹配？ → 是 → 提供候选
    └─ 语义匹配？ → 是 → 提供候选（多个）
    ↓
第三层：人工处理
    ├─ 选择候选 → 确认映射
    ├─ 手动映射 → 建立映射关系
    └─ 无法匹配 → 标记待处理
    ↓
映射关系输出
```

## 详细设计方案

### 方案一：传统精确匹配（优先级最高）

**适用科目统计**：177个科目（71.4%）

#### 1.1 完全匹配规则
- **适用场景**：对方系统科目编码和名称与本系统完全一致
- **适用科目**：161个标准科目（完全匹配类型）
  - 如：1001-库存现金、1002-银行存款、1121-应收票据等
  - 详见：`04-参考资料/业务文档/小企业会计准则-默认科目.csv`（匹配方法列标注为"传统精确匹配"）
- **匹配条件**：
  - 编码完全一致（考虑格式差异：大小写、空格、特殊字符）
  - 名称完全一致（考虑格式差异）
- **处理方式**：
  - 自动建立一对一映射关系
  - 无需人工确认
  - 记录匹配类型为"完全匹配"
- **预期覆盖率**：约30-50%（取决于对方系统）

#### 1.2 编码匹配规则
- **适用场景**：编码相同但名称可能不同
- **匹配条件**：
  - 编码完全一致（标准化后）
  - 名称可能不同
- **处理方式**：
  - 自动匹配编码
  - 标记名称差异
  - 提供人工确认选项
- **预期覆盖率**：约10-20%

#### 1.3 层级匹配规则（已升级为大模型匹配）
- **适用场景**：多级科目结构，层级和名称可能不完全相同
- **适用科目**：141个二级及多级科目（68.6%）
  - 如：150101-债券投资、150102-其他债权投资、160401-建筑工程等
  - 详见：`04-参考资料/业务文档/小企业会计准则-默认科目.csv`（匹配方法列标注为"智能语义匹配（大模型）"）
- **问题分析**：
  - 传统层级匹配效果有限（60-70%准确率）
  - 编码格式、层级分隔符、名称表述都可能不同
  - 需要语义理解能力
- **解决方案**：使用大模型进行语义匹配
  - 详见：`02-需求分析/业务分析/基于大模型的二级科目匹配方案.md`
- **处理方式**：
  - 提取科目上下文信息（父科目、类别、方向等）
  - 构建Prompt调用大模型API
  - 返回最佳匹配和候选列表（带置信度）
- **预期准确率**：≥90%（相比传统方法的60-70%）

### 方案二：智能语义匹配（处理不一致情况）

**适用科目统计**：144个科目（68.6%）

**重要更新**：二级及多级科目（141个）已升级为使用大模型匹配，详见：`02-需求分析/业务分析/基于大模型的二级科目匹配方案.md`

#### 2.1 编码相似度匹配
- **适用场景**：编码格式不同但内容相似
- **匹配算法**：
  - 编辑距离算法（Levenshtein距离）
  - 编码标准化后比较
  - 相似度阈值：≥85%
- **处理方式**：
  - 计算相似度分数
  - 提供Top-N候选列表
  - 用户选择确认

#### 2.2 名称语义匹配（大模型方案）
- **适用场景**：名称相似但编码不同，特别是二级及多级科目
- **匹配算法**：
  - **大模型语义匹配**（推荐）：使用GPT-4/GPT-3.5等大模型
  - 编辑距离算法（备选）：作为补充
  - 同义词匹配：结合大模型结果
- **大模型匹配流程**：
  1. 提取科目上下文（父科目、类别、方向等）
  2. 构建Prompt，包含本系统科目和对方系统候选科目
  3. 调用大模型API进行语义理解
  4. 返回最佳匹配（置信度）+ 候选列表 + 匹配依据
- **置信度阈值**：
  - 高置信度（≥0.9）：自动匹配，标记需确认
  - 中置信度（0.7-0.9）：提供候选列表，用户选择
  - 低置信度（<0.7）：标记待处理，建议手动映射
- **处理方式**：
  - 提供匹配度评分和置信度
  - 显示匹配依据（大模型解释）
  - 支持批量确认
- **成本优化**：
  - 分层调用：先用传统方法过滤
  - 缓存机制：缓存相同来源系统的匹配结果
  - 批量处理：一次调用处理多个科目

#### 2.3 同义词匹配
- **适用场景**：科目名称是同义词关系
- **同义词库**：
  - "银行存款" ↔ "银行账户"
  - "应收账款" ↔ "应收款"
  - "库存商品" ↔ "存货"
  - 等...
- **处理方式**：
  - 建立同义词映射表
  - 优先匹配同义词
  - 记录同义词匹配关系

### 方案三：特殊处理规则

#### 3.1 删除科目处理
- **场景**：对方系统科目在本系统中已删除
- **适用科目**：36个删除科目
  - 如：1004-备用金、101201-银行汇票、110101-股票等
  - 详见：`04-参考资料/业务文档/小企业会计准则-默认科目.csv`（匹配方法列标注为"智能语义匹配"，操作列标注为"删除"）
- **处理策略**：
  - 标记为"已删除科目"
  - 提供替代方案建议（映射到父科目或相近科目）
  - 记录删除原因
  - 需要人工确认替代映射

#### 3.2 新增科目处理
- **场景**：对方系统科目在本系统中不存在，或本系统新增科目对方系统可能没有
- **适用科目**：27个新增科目
  - 如：1406-发出商品等
  - 详见：`04-参考资料/业务文档/小企业会计准则-默认科目.csv`（匹配方法列标注为"智能语义匹配"，操作列标注为"新增"或修改后SAAS的默认科目有值但当前版本为空）
- **处理策略**：
  - 标记为"未匹配科目"
  - 提供相近科目建议
  - 支持创建新科目（需权限控制）
  - 或映射到相近科目

#### 3.3 辅助核算处理
- **场景**：对方系统科目有辅助核算项目
- **适用科目**：3个有辅助核算的科目
  - 如：1122-应收账款（辅助：客户）、1405-库存商品（辅助：存货）
  - 详见：`04-参考资料/业务文档/小企业会计准则-默认科目.csv`（匹配方法列标注为"智能语义匹配"，辅助列有值）
- **处理策略**：
  - 先建立科目映射
  - 再建立辅助核算映射
  - 验证辅助核算的完整性

## 数据预处理设计

### 1. 数据清洗规则
- **编码清洗**：
  - 去除前后空格
  - 统一大小写
  - 去除特殊字符（保留必要分隔符）
  - 标准化格式（如：1001.01 → 100101）
- **名称清洗**：
  - 去除前后空格
  - 统一全角/半角
  - 去除多余空格
  - 标准化标点符号

### 2. 数据标准化
- **编码标准化**：
  - 统一编码格式（纯数字/带字母）
  - 统一层级分隔符
  - 统一编码长度
- **名称标准化**：
  - 统一术语（如：统一使用"银行存款"而非"银行账户"）
  - 去除冗余词汇
  - 统一缩写形式

## 映射关系管理设计

### 1. 映射关系存储结构
```json
{
  "source_system": "对方系统名称",
  "source_code": "对方科目编码",
  "source_name": "对方科目名称",
  "target_code": "本系统科目编码",
  "target_name": "本系统科目名称",
  "match_type": "完全匹配/编码匹配/名称匹配/语义匹配/手动映射",
  "match_score": 0.95,
  "match_confidence": "高/中/低",
  "mapping_status": "已确认/待确认/已拒绝",
  "created_at": "2026-02-09 10:00:00",
  "confirmed_by": "用户ID",
  "notes": "备注信息"
}
```

### 2. 映射关系模板
- **功能**：保存常用映射关系，支持复用
- **应用场景**：
  - 相同来源系统的多次导账
  - 相同行业的标准科目体系
- **管理方式**：
  - 支持导入/导出映射模板
  - 支持版本管理
  - 支持模板共享

### 3. 映射关系验证
- **完整性检查**：
  - 所有对方科目是否都有映射
  - 是否有重复映射
  - 是否有冲突映射
- **准确性检查**：
  - 科目类型是否一致
  - 余额方向是否正确
  - 层级关系是否合理

## 用户交互设计

### 1. 自动匹配界面
- **显示内容**：
  - 匹配结果统计（已匹配/待确认/未匹配数量）
  - 匹配度评分
  - 匹配依据说明
- **操作功能**：
  - 一键确认所有高置信度匹配
  - 批量确认选中项
  - 查看匹配详情

### 2. 候选选择界面
- **显示内容**：
  - 对方科目信息
  - 候选科目列表（按相似度排序）
  - 相似度评分和匹配依据
- **操作功能**：
  - 选择最佳匹配
  - 手动搜索科目
  - 标记为无法匹配

### 3. 手动映射界面
- **显示内容**：
  - 对方科目列表（未匹配）
  - 本系统科目树（可搜索）
  - 映射关系预览
- **操作功能**：
  - 拖拽建立映射
  - 搜索科目
  - 批量映射
  - 验证映射关系

## 性能优化设计

### 1. 匹配算法优化
- **索引优化**：
  - 建立科目编码索引
  - 建立科目名称索引
  - 建立同义词索引
- **缓存策略**：
  - 缓存常用映射关系
  - 缓存匹配结果
  - 缓存同义词库

### 2. 批量处理优化
- **分批处理**：
  - 大量科目分批匹配
  - 异步处理长时间任务
  - 显示处理进度
- **并行处理**：
  - 多线程匹配
  - 分布式处理（如需要）

## 异常处理设计

### 1. 数据异常
- **缺失数据**：标记为异常，提供补全功能
- **格式错误**：自动修复或提示用户
- **重复数据**：去重或标记冲突

### 2. 匹配异常
- **无匹配结果**：标记为待处理，提供建议
- **多匹配结果**：提供候选列表，用户选择
- **匹配冲突**：检测并提示，提供解决建议

### 3. 映射异常
- **映射冲突**：检测一对多或多对一冲突
- **映射缺失**：检查完整性，提示缺失项
- **映射错误**：支持回滚和修正

## 实施建议

### 第一阶段：基础匹配（MVP）
1. 实现完全匹配和编码匹配
2. 实现简单的名称相似度匹配
3. 实现基本的手动映射功能
4. **预期覆盖率**：60-70%

### 第二阶段：智能匹配
1. 实现语义匹配算法
2. 建立同义词库
3. 实现候选列表和批量确认
4. **预期覆盖率**：80-90%

### 第三阶段：优化和完善
1. 映射关系模板管理
2. 性能优化
3. 异常处理完善
4. **预期覆盖率**：95%+

## 关键指标

- **自动匹配率**：≥70%（无需人工干预）
- **匹配准确率**：≥95%（匹配结果正确）
- **处理效率**：1000个科目/分钟
- **用户满意度**：操作便捷，结果准确

## 科目匹配方法分类清单

### 传统精确匹配科目（177个，71.4%）

**完全匹配科目（161个）**：
- 标准科目，编码和名称都完全一致
- 如：1001-库存现金、1002-银行存款、1121-应收票据、1403-原材料等
- **匹配方法**：完全匹配（编码+名称）或编码匹配

**层级匹配科目（16个）**：
- 多级科目结构，需要处理层级关系
- 如：101201-银行汇票、110101-股票等明细科目
- **匹配方法**：层级匹配，处理多级科目结构

**详细清单**：请查看 `04-参考资料/业务文档/小企业会计准则-默认科目.csv`，筛选"匹配方法"列="传统精确匹配"

### 智能语义匹配科目（71个，28.6%）

**删除科目（36个）**：
- 本系统已删除，但对方系统可能有
- 如：1004-备用金、101201-银行汇票、110101-股票等
- **匹配方法**：智能匹配，提供替代方案建议

**新增科目（27个）**：
- 本系统新增，对方系统可能没有
- 如：1406-发出商品等
- **匹配方法**：智能匹配，提供相近科目建议或创建新科目

**辅助核算科目（3个）**：
- 有辅助核算项目，需要额外处理
- 如：1122-应收账款（辅助：客户）、1405-库存商品（辅助：存货）
- **匹配方法**：智能匹配，需要处理辅助核算映射

**待讨论科目（5个）**：
- 需要人工确认的科目
- **匹配方法**：智能匹配，提供候选列表供选择

**详细清单**：请查看 `04-参考资料/业务文档/小企业会计准则-默认科目.csv`，筛选"匹配方法"列="智能语义匹配"

## 总结

本设计方案采用分层匹配策略，优先使用传统精确匹配处理大部分科目（177个，71.4%），使用智能语义匹配处理不一致情况（71个，28.6%），通过人工干预处理复杂场景。通过数据预处理、映射关系管理和用户交互设计，实现高效、准确的导账科目映射功能。

**所有科目的匹配方法已标注在科目数据文件中**，详见：`04-参考资料/业务文档/小企业会计准则-默认科目.csv`（新增"匹配方法"和"匹配方法说明"列）
