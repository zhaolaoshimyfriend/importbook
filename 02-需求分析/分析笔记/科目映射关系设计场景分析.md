# 科目映射关系设计场景分析

## 背景说明

- **默认科目模板**：已确定
- **导账流程**：对方系统（其他财务软件）科目 → 中间表 → 映射关系输出
- **输出内容**：本系统默认科目 ↔ 对方系统科目的映射关系

## 需要考虑的核心场景

### 1. 科目匹配场景

#### 1.1 完全匹配
- **场景描述**：对方系统科目与本系统默认科目完全一致（科目编码、科目名称都相同）
- **处理方式**：自动建立一对一映射关系
- **注意事项**：
  - 需要考虑编码格式差异（大小写、空格、特殊字符）
  - 需要考虑编码体系差异（纯数字 vs 带字母）

#### 1.2 名称匹配但编码不同
- **场景描述**：科目名称相同或相似，但科目编码不同
- **处理方式**：
  - 优先匹配名称
  - 需要人工确认或设置匹配规则
- **注意事项**：
  - 名称可能存在同义词（如"银行存款" vs "银行账户"）
  - 需要考虑名称的标准化处理

#### 1.3 编码匹配但名称不同
- **场景描述**：科目编码相同或相似，但科目名称不同
- **处理方式**：
  - 优先匹配编码
  - 需要人工确认映射关系
- **注意事项**：
  - 编码可能存在格式差异
  - 需要建立编码转换规则

#### 1.4 部分匹配（模糊匹配）
- **场景描述**：科目名称或编码部分相似
- **处理方式**：
  - 使用相似度算法（如编辑距离、语义相似度）
  - 提供候选映射列表供用户选择
- **注意事项**：
  - 需要设置相似度阈值
  - 可能存在多个候选匹配

#### 1.5 无法匹配（新科目）
- **场景描述**：对方系统科目在本系统默认科目模板中不存在
- **处理方式**：
  - 标记为"待映射"或"未匹配"
  - 提供手动映射功能
  - 可选择创建新科目或映射到相近科目
- **注意事项**：
  - 需要记录未匹配原因
  - 需要考虑是否允许新增科目到默认模板

### 2. 科目层级关系场景

#### 2.1 多级科目结构
- **场景描述**：对方系统使用多级科目结构（如：1001.01.001）
- **处理方式**：
  - 需要解析科目层级
  - 建立层级映射关系
  - 考虑是否需要扁平化处理
- **注意事项**：
  - 不同系统的层级分隔符可能不同
  - 需要确定映射到本系统的哪一级

#### 2.2 科目级数不一致
- **场景描述**：对方系统科目级数与本系统不一致
- **处理方式**：
  - 建立级数转换规则
  - 提供级数映射配置
- **注意事项**：
  - 可能需要合并或拆分科目
  - 需要保持科目余额的准确性

#### 2.3 父科目与子科目映射
- **场景描述**：对方系统父科目需要映射到本系统的子科目，或反之
- **处理方式**：
  - 支持跨层级映射
  - 需要验证映射后的科目结构完整性
- **注意事项**：
  - 需要检查科目余额汇总逻辑
  - 避免循环引用

### 3. 科目属性映射场景

#### 3.1 科目类型映射
- **场景描述**：不同系统的科目分类体系不同（资产/负债/权益/收入/费用）
- **处理方式**：
  - 建立科目类型映射表
  - 验证映射后的科目类型一致性
- **注意事项**：
  - 需要确保科目类型转换的准确性
  - 可能影响报表生成逻辑

#### 3.2 科目方向映射
- **场景描述**：对方系统科目余额方向（借方/贷方）与本系统不一致
- **处理方式**：
  - 记录余额方向差异
  - 在数据导入时进行方向转换
- **注意事项**：
  - 需要明确标记方向转换规则
  - 影响后续余额计算

#### 3.3 辅助核算映射
- **场景描述**：对方系统的辅助核算项目（如部门、项目、客户）需要映射
- **处理方式**：
  - 建立辅助核算映射关系
  - 支持一对多或多对一映射
- **注意事项**：
  - 辅助核算可能比科目更复杂
  - 需要考虑辅助核算的层级关系

### 4. 一对多和多对一映射场景

#### 4.1 一对多映射
- **场景描述**：对方系统一个科目需要映射到本系统多个科目
- **处理方式**：
  - 支持拆分映射
  - 需要设置拆分比例或规则
- **注意事项**：
  - 需要明确拆分依据（如按比例、按金额范围、按辅助核算）
  - 需要验证拆分后余额的准确性

#### 4.2 多对一映射
- **场景描述**：对方系统多个科目需要合并映射到本系统一个科目
- **处理方式**：
  - 支持合并映射
  - 需要验证合并后的科目余额
- **注意事项**：
  - 需要确保合并逻辑正确
  - 可能需要保留原始科目信息用于追溯

#### 4.3 交叉映射
- **场景描述**：复杂的多对多映射关系
- **处理方式**：
  - 需要拆分为多个一对多或多对一关系
  - 提供映射关系矩阵视图
- **注意事项**：
  - 需要验证映射的完整性和准确性
  - 避免数据重复或遗漏

### 5. 数据质量场景

#### 5.1 科目编码不规范
- **场景描述**：对方系统科目编码存在空格、特殊字符、格式不统一等问题
- **处理方式**：
  - 数据清洗和标准化
  - 建立编码转换规则
- **注意事项**：
  - 需要在中间表阶段进行预处理
  - 记录清洗规则和异常数据

#### 5.2 科目名称重复
- **场景描述**：对方系统存在相同名称但不同编码的科目
- **处理方式**：
  - 优先使用编码区分
  - 需要人工确认映射关系
- **注意事项**：
  - 需要建立唯一性校验规则
  - 避免误映射

#### 5.3 科目缺失关键信息
- **场景描述**：对方系统科目缺少编码、名称或其他关键属性
- **处理方式**：
  - 标记为异常数据
  - 提供数据补全功能
- **注意事项**：
  - 需要定义必填字段
  - 建立数据校验规则

### 6. 业务规则场景

#### 6.1 科目使用状态
- **场景描述**：对方系统存在已停用、已删除的科目
- **处理方式**：
  - 过滤停用科目或标记状态
  - 提供是否导入停用科目的选项
- **注意事项**：
  - 历史数据可能需要停用科目
  - 需要明确业务规则

#### 6.2 科目余额方向检查
- **场景描述**：映射后需要验证科目余额方向是否符合会计规则
- **处理方式**：
  - 建立余额方向校验规则
  - 提供异常提示
- **注意事项**：
  - 资产类科目通常借方余额
  - 负债类科目通常贷方余额

#### 6.3 科目余额合理性检查
- **场景描述**：映射后科目余额是否在合理范围内
- **处理方式**：
  - 设置余额范围检查
  - 提供异常预警
- **注意事项**：
  - 需要根据科目类型设置不同的检查规则
  - 考虑行业和规模差异

### 7. 映射关系管理场景

#### 7.1 映射关系保存和复用
- **场景描述**：相同来源系统的映射关系可以保存和复用
- **处理方式**：
  - 建立映射关系模板
  - 支持映射关系的导入导出
- **注意事项**：
  - 需要考虑不同期间科目可能变化
  - 需要版本管理

#### 7.2 映射关系版本管理
- **场景描述**：映射关系可能需要调整，需要保留历史版本
- **处理方式**：
  - 支持映射关系版本控制
  - 记录变更历史
- **注意事项**：
  - 需要支持版本回退
  - 需要记录变更原因

#### 7.3 批量映射操作
- **场景描述**：大量科目需要批量建立映射关系
- **处理方式**：
  - 支持Excel导入映射关系
  - 支持批量匹配和确认
- **注意事项**：
  - 需要提供批量操作的模板
  - 需要验证批量数据的准确性

### 8. 用户交互场景

#### 8.1 自动匹配建议
- **场景描述**：系统自动匹配后，提供匹配建议供用户确认
- **处理方式**：
  - 显示匹配度评分
  - 提供多个候选选项
  - 支持一键确认或批量确认
- **注意事项**：
  - 需要清晰的匹配依据说明
  - 提供匹配详情查看

#### 8.2 手动映射界面
- **场景描述**：用户需要手动建立或调整映射关系
- **处理方式**：
  - 提供友好的映射界面
  - 支持搜索和筛选
  - 支持拖拽操作
- **注意事项**：
  - 需要实时验证映射关系
  - 提供操作提示和帮助

#### 8.3 映射关系预览和验证
- **场景描述**：映射关系建立后，需要预览和验证效果
- **处理方式**：
  - 提供映射关系总览
  - 显示映射统计信息（已映射/未映射数量）
  - 提供数据预览功能
- **注意事项**：
  - 需要显示映射覆盖率
  - 提供异常数据提示

### 9. 异常处理场景

#### 9.1 映射冲突处理
- **场景描述**：一个对方科目被映射到多个本系统科目，或反之
- **处理方式**：
  - 检测并提示冲突
  - 提供冲突解决机制
- **注意事项**：
  - 需要明确冲突解决规则
  - 记录冲突处理历史

#### 9.2 映射缺失处理
- **场景描述**：部分科目未建立映射关系
- **处理方式**：
  - 标记未映射科目
  - 提供强制映射或跳过选项
- **注意事项**：
  - 需要明确未映射科目的处理策略
  - 可能影响数据导入的完整性

#### 9.3 映射错误回滚
- **场景描述**：发现映射错误，需要回滚
- **处理方式**：
  - 支持映射关系撤销
  - 支持批量回滚
- **注意事项**：
  - 需要检查回滚的影响范围
  - 可能需要重新导入数据

### 10. 性能和数据量场景

#### 10.1 大量科目处理
- **场景描述**：对方系统可能有数千甚至上万个科目
- **处理方式**：
  - 优化匹配算法性能
  - 支持分批处理
  - 提供进度显示
- **注意事项**：
  - 需要考虑内存和计算资源
  - 可能需要异步处理

#### 10.2 映射关系查询性能
- **场景描述**：需要快速查询和展示映射关系
- **处理方式**：
  - 建立索引
  - 支持缓存
  - 分页加载
- **注意事项**：
  - 需要考虑数据量增长
  - 优化查询SQL

## 总结

科目映射关系设计是一个复杂的业务场景，需要综合考虑：

1. **匹配算法**：支持多种匹配方式（完全匹配、模糊匹配、语义匹配）
2. **映射规则**：支持一对一、一对多、多对一等多种映射关系
3. **数据质量**：数据清洗、校验、异常处理
4. **用户体验**：友好的交互界面、智能建议、批量操作
5. **业务规则**：科目类型、余额方向、层级关系等业务约束
6. **可维护性**：映射关系保存、版本管理、模板复用

建议按照优先级逐步实现，先支持核心场景（完全匹配、一对一映射），再逐步完善复杂场景。
